{% extends "base.html" %}

{% block title %}Comparison Results - AI Website Analyzer{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.medal { font-size: 1.5rem; }
.rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
.rank-2 { background: linear-gradient(135deg, #64748B 0%, #475569 100%); }
.rank-3 { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }

/* Share Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
}

.modal.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.share-option {
    transition: all 0.2s;
}

.share-option:hover {
    transform: translateX(5px);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        
        <!-- Loading State -->
        <div id="loadingState" class="text-center py-20">
            <div class="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Loading Comparison...</h2>
            <p class="text-gray-600">Please wait while we fetch your results</p>
        </div>

        <!-- Results Content -->
        <div id="resultsContent" class="hidden">
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-primary to-secondary rounded-2xl shadow-lg p-8 mb-6 text-white">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold mb-2">Competitive Analysis</h1>
                        <p class="text-white/90" id="headerInfo"></p>
                    </div>
                    <div class="text-right">
                        <div class="text-sm opacity-90">Your Rank</div>
                        <div class="text-5xl font-bold" id="yourRank">-</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <button onclick="downloadPDF()" id="pdfButton" class="bg-red-600 text-white p-4 rounded-xl hover:bg-red-700 transition flex flex-col items-center">
                    <svg class="w-6 h-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="font-semibold">PDF Report</span>
                </button>
                
                <button onclick="exportToCSV()" class="bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 transition flex flex-col items-center">
                    <svg class="w-6 h-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    <span class="font-semibold">Export CSV</span>
                </button>
                
                <button onclick="window.location.href='/compare'" class="bg-purple-600 text-white p-4 rounded-xl hover:bg-purple-700 transition flex flex-col items-center">
                    <svg class="w-6 h-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span class="font-semibold">New Comparison</span>
                </button>
                
                <button onclick="shareComparison()" class="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 transition flex flex-col items-center">
                    <svg class="w-6 h-6 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    <span class="font-semibold">Share</span>
                </button>
            </div>

            <!-- Overall Score Comparison -->
            <div class="bg-white rounded-2xl shadow-md p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Overall Score Comparison</h2>
                <div id="overallScores" class="space-y-4"></div>
            </div>

            <!-- Category Comparison Table -->
            <div class="bg-white rounded-2xl shadow-md p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Category Rankings</h2>
                <div class="overflow-x-auto">
                    <table class="w-full" id="categoryTable">
                        <thead>
                            <tr class="border-b-2 border-gray-200">
                                <th class="text-left py-3 px-4 font-semibold text-gray-700">Category</th>
                            </tr>
                        </thead>
                        <tbody id="categoryTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Strengths & Weaknesses -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Strengths -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl shadow-md p-8 border border-green-200">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Your Strengths</h2>
                    </div>
                    <div id="strengthsList" class="space-y-3"></div>
                </div>

                <!-- Weaknesses -->
                <div class="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl shadow-md p-8 border border-red-200">
                    <div class="flex items-center mb-4">
                        <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center mr-4">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Areas to Improve</h2>
                    </div>
                    <div id="weaknessesList" class="space-y-3"></div>
                </div>
            </div>

            <!-- Opportunities -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-md p-8 mb-6 border border-blue-200">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Quick Win Opportunities</h2>
                </div>
                <div id="opportunitiesList" class="space-y-3"></div>
            </div>

            <!-- AI Insights -->
            <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-md p-8 mb-6 border border-purple-200">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center mr-4">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">AI Strategic Insights</h2>
                </div>
                <div id="aiInsights" class="prose prose-lg max-w-none text-gray-700"></div>
            </div>

        </div>
    </div>
</div>

<!-- Share Modal -->
<div id="shareModal" class="modal">
    <div class="modal-content">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-900">Share Comparison</h3>
            <button onclick="closeShareModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>

        <!-- Share Link Section -->
        <div id="shareLinkSection" class="hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                <div class="flex items-center mb-2">
                    <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="font-semibold text-green-800">Share Link Created!</span>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="text" id="shareUrlInput" readonly 
                           class="flex-1 px-3 py-2 border border-green-300 rounded-lg bg-white text-sm">
                    <button onclick="copyShareLink()" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        Copy
                    </button>
                </div>
                <p class="text-sm text-gray-600 mt-2">
                    <span id="shareExpiry"></span> • <span id="shareViews">0 views</span>
                </p>
            </div>
        </div>

        <!-- Share Options -->
        <div id="shareOptions">
            <p class="text-gray-600 mb-4">Choose how you want to share this comparison:</p>
            
            <!-- Quick Share -->
            <button onclick="createQuickShare()" 
                    class="share-option w-full flex items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg mb-3 border border-blue-200">
                <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                    </svg>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-900">Quick Share Link</div>
                    <div class="text-sm text-gray-600">Generate a shareable link (expires in 30 days)</div>
                </div>
            </button>

            <!-- Social Media -->
            <div class="grid grid-cols-3 gap-3 mb-3">
                <button onclick="shareToTwitter()" 
                        class="share-option flex flex-col items-center p-4 bg-sky-50 hover:bg-sky-100 rounded-lg border border-sky-200">
                    <svg class="w-8 h-8 text-sky-500 mb-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                    </svg>
                    <span class="text-xs font-semibold text-gray-700">Twitter</span>
                </button>

                <button onclick="shareToLinkedIn()" 
                        class="share-option flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg border border-blue-200">
                    <svg class="w-8 h-8 text-blue-600 mb-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                    </svg>
                    <span class="text-xs font-semibold text-gray-700">LinkedIn</span>
                </button>

                <button onclick="shareToEmail()" 
                        class="share-option flex flex-col items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200">
                    <svg class="w-8 h-8 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-xs font-semibold text-gray-700">Email</span>
                </button>
            </div>

            <!-- Copy Current URL -->
            <button onclick="copyCurrentUrl()" 
                    class="share-option w-full flex items-center p-4 bg-gray-50 hover:bg-gray-100 rounded-lg border border-gray-200">
                <div class="w-12 h-12 bg-gray-500 rounded-lg flex items-center justify-center mr-4">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <div class="text-left">
                    <div class="font-semibold text-gray-900">Copy Current URL</div>
                    <div class="text-sm text-gray-600">Share the current page URL</div>
                </div>
            </button>
        </div>

        <!-- Loading State -->
        <div id="shareLoading" class="hidden text-center py-8">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-gray-600">Creating share link...</p>
        </div>
    </div>
</div>

<script>
const comparisonId = "{{ comparison_id }}";
let comparisonData = null;
let currentShareData = null;

async function loadComparison() {
    try {
        const response = await fetch(`/api/v1/comparisons/${comparisonId}`);
        
        if (!response.ok) {
            throw new Error('Failed to load comparison');
        }
        
        comparisonData = await response.json();
        
        if (comparisonData.status === 'processing') {
            setTimeout(loadComparison, 2000);
            return;
        }
        
        if (comparisonData.status === 'completed') {
            displayResults(comparisonData);
        } else {
            throw new Error('Comparison failed');
        }
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('loadingState').innerHTML = `
            <div class="text-center py-20">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Error Loading Comparison</h2>
                <p class="text-gray-600 mb-4">${error.message}</p>
                <button onclick="window.location.href='/compare'" class="px-6 py-3 bg-primary text-white rounded-lg hover:opacity-90">
                    Start New Comparison
                </button>
            </div>
        `;
    }
}

function displayResults(data) {
    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('resultsContent').classList.remove('hidden');
    
    // Header info
    const yourUrl = data.your_website.url;
    const competitorCount = data.competitors.length;
    document.getElementById('headerInfo').textContent = 
        `${yourUrl} vs ${competitorCount} competitor${competitorCount > 1 ? 's' : ''}`;
    
    // Your rank
    const yourRankData = data.rankings.overall.find(r => r.is_yours);
    document.getElementById('yourRank').innerHTML = `${yourRankData.medal} #${yourRankData.rank}`;
    
    // Overall scores
    displayOverallScores(data.rankings.overall);
    
    // Category table
    displayCategoryTable(data);
    
    // Strengths, weaknesses, opportunities
    displayInsights(data.insights);
    
    // AI insights
    displayAIInsights(data.ai_summary);
}

function displayOverallScores(rankings) {
    const container = document.getElementById('overallScores');
    container.innerHTML = rankings.map(item => {
        const percentage = (item.score / 100) * 100;
        const isYours = item.is_yours;
        const bgColor = isYours ? 'bg-primary' : 'bg-gray-300';
        
        return `
            <div class="flex items-center space-x-4">
                <div class="w-32 flex-shrink-0">
                    <div class="flex items-center space-x-2">
                        <span class="medal">${item.medal}</span>
                        <span class="font-semibold text-gray-700">#${item.rank}</span>
                    </div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-sm font-medium ${isYours ? 'text-primary font-bold' : 'text-gray-700'}">
                            ${isYours ? 'YOUR SITE: ' : ''}${item.url}
                        </span>
                        <span class="text-lg font-bold ${isYours ? 'text-primary' : 'text-gray-900'}">
                            ${item.score}
                        </span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div class="${bgColor} h-3 rounded-full transition-all duration-500" 
                             style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function displayCategoryTable(data) {
    const categories = ['ux', 'seo', 'performance', 'content', 'security', 'images'];
    const categoryNames = {
        'ux': 'UX',
        'seo': 'SEO',
        'performance': 'Performance',
        'content': 'Content',
        'security': 'Security',
        'images': 'Images'
    };
    
    // Add header columns
    const allUrls = [data.your_website.url, ...data.competitors.map(c => c.url)];
    const thead = document.querySelector('#categoryTable thead tr');
    allUrls.forEach((url, index) => {
        const th = document.createElement('th');
        th.className = 'text-center py-3 px-4 font-semibold text-gray-700';
        th.innerHTML = index === 0 ? `You` : `Comp ${index}`;
        thead.appendChild(th);
    });
    
    // Add rows
    const tbody = document.getElementById('categoryTableBody');
    tbody.innerHTML = categories.map(category => {
        const rankings = data.rankings[category];
        const cells = allUrls.map(url => {
            const item = rankings.find(r => r.url === url);
            return `
                <td class="text-center py-4 px-4">
                    <div class="flex flex-col items-center">
                        <span class="text-2xl mb-1">${item.medal}</span>
                        <span class="text-lg font-bold ${item.is_yours ? 'text-primary' : 'text-gray-900'}">
                            ${item.score}
                        </span>
                    </div>
                </td>
            `;
        }).join('');
        
        return `
            <tr class="border-b border-gray-100 hover:bg-gray-50">
                <td class="py-4 px-4 font-semibold text-gray-900">${categoryNames[category]}</td>
                ${cells}
            </tr>
        `;
    }).join('');
}

function displayInsights(insights) {
    // Strengths
    const strengthsList = document.getElementById('strengthsList');
    if (insights.strengths.length > 0) {
        strengthsList.innerHTML = insights.strengths.map(s => `
            <div class="bg-white rounded-lg p-4 border border-green-200">
                <div class="flex items-start">
                    <span class="text-2xl mr-3">✓</span>
                    <div>
                        <div class="font-semibold text-gray-900">${s.category}</div>
                        <div class="text-sm text-gray-600">${s.message}</div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        strengthsList.innerHTML = '<p class="text-gray-600">No leading categories yet. Keep improving!</p>';
    }
    
    // Weaknesses
    const weaknessesList = document.getElementById('weaknessesList');
    if (insights.weaknesses.length > 0) {
        weaknessesList.innerHTML = insights.weaknesses.map(w => `
            <div class="bg-white rounded-lg p-4 border border-red-200">
                <div class="flex items-start">
                    <span class="text-2xl mr-3">!</span>
                    <div>
                        <div class="font-semibold text-gray-900">${w.category}</div>
                        <div class="text-sm text-gray-600">${w.message}</div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        weaknessesList.innerHTML = '<p class="text-gray-600">You\'re leading in all categories!</p>';
    }
    
    // Opportunities
    const opportunitiesList = document.getElementById('opportunitiesList');
    if (insights.opportunities.length > 0) {
        opportunitiesList.innerHTML = insights.opportunities.map(o => `
            <div class="bg-white rounded-lg p-4 border border-blue-200">
                <div class="flex items-start">
                    <span class="text-2xl mr-3">→</span>
                    <div>
                        <div class="font-semibold text-gray-900">${o.category}</div>
                        <div class="text-sm text-gray-600">${o.message}</div>
                    </div>
                </div>
            </div>
        `).join('');
    } else {
        opportunitiesList.innerHTML = '<p class="text-gray-600">Focus on the major gaps first for maximum impact.</p>';
    }
}

function displayAIInsights(aiSummary) {
    const container = document.getElementById('aiInsights');
    if (aiSummary && typeof marked !== 'undefined') {
        container.innerHTML = marked.parse(aiSummary);
    } else {
        container.innerHTML = '<p class="text-gray-600">AI insights are being generated...</p>';
    }
}

function exportToCSV() {
    if (!comparisonData) return;
    
    // Create CSV content
    let csv = 'Category,Your Score,';
    comparisonData.competitors.forEach((c, i) => {
        csv += `Competitor ${i + 1},`;
    });
    csv += '\n';
    
    const categories = ['overall', 'ux', 'seo', 'performance', 'content', 'security', 'images'];
    categories.forEach(cat => {
        const rankings = comparisonData.rankings[cat];
        csv += `${cat.charAt(0).toUpperCase() + cat.slice(1)},`;
        
        rankings.forEach(r => {
            csv += `${r.score},`;
        });
        csv += '\n';
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `comparison_${comparisonId}.csv`;
    a.click();
}

function shareComparison() {
    document.getElementById('shareModal').classList.add('active');
}

function closeShareModal() {
    document.getElementById('shareModal').classList.remove('active');
}

// Close modal when clicking outside
document.getElementById('shareModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeShareModal();
    }
});

async function createQuickShare() {
    const shareOptions = document.getElementById('shareOptions');
    const shareLoading = document.getElementById('shareLoading');
    const shareLinkSection = document.getElementById('shareLinkSection');
    
    try {
        // Show loading
        shareOptions.classList.add('hidden');
        shareLoading.classList.remove('hidden');
        
        // Create share link
        const response = await fetch(`/api/v1/share/comparison/${comparisonId}/share`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                expires_in_days: 30
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to create share link');
        }
        
        const data = await response.json();
        currentShareData = data;
        
        // Show share link
        shareLoading.classList.add('hidden');
        shareLinkSection.classList.remove('hidden');
        
        // Populate share link
        const fullUrl = window.location.origin + data.share_url;
        document.getElementById('shareUrlInput').value = fullUrl;
        
        // Set expiry date
        const expiryDate = new Date(data.expires_at);
        document.getElementById('shareExpiry').textContent = 
            `Expires ${expiryDate.toLocaleDateString()}`;
        
    } catch (error) {
        console.error('Share error:', error);
        alert('Failed to create share link. Please try again.');
        shareLoading.classList.add('hidden');
        shareOptions.classList.remove('hidden');
    }
}

function copyShareLink() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    document.execCommand('copy');
    
    // Show feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    button.classList.add('bg-green-700');
    
    setTimeout(() => {
        button.textContent = originalText;
        button.classList.remove('bg-green-700');
    }, 2000);
}

function copyCurrentUrl() {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
        alert('URL copied to clipboard!');
        closeShareModal();
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy URL');
    });
}

function shareToTwitter() {
    if (!comparisonData) return;
    
    const yourUrl = comparisonData.your_website.url;
    const rank = comparisonData.rankings.overall.find(r => r.is_yours).rank;
    const score = comparisonData.rankings.overall.find(r => r.is_yours).score;
    
    const text = `I analyzed my website ${yourUrl} against competitors and ranked #${rank} with a score of ${score}/100!`;
    const url = window.location.href;
    
    window.open(
        `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`,
        '_blank',
        'width=550,height=420'
    );
}

function shareToLinkedIn() {
    const url = window.location.href;
    window.open(
        `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`,
        '_blank',
        'width=550,height=420'
    );
}

function shareToEmail() {
    if (!comparisonData) return;
    
    const yourUrl = comparisonData.your_website.url;
    const rank = comparisonData.rankings.overall.find(r => r.is_yours).rank;
    const score = comparisonData.rankings.overall.find(r => r.is_yours).score;
    
    const subject = 'Competitive Website Analysis Results';
    const body = `Check out my competitive analysis results!\n\nWebsite: ${yourUrl}\nRank: #${rank}\nScore: ${score}/100\n\nView full report: ${window.location.href}`;
    
    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
}

async function downloadPDF() {
    const button = document.getElementById('pdfButton');
    const originalHTML = button.innerHTML;
    
    try {
        // Show loading state
        button.disabled = true;
        button.innerHTML = `
            <svg class="w-6 h-6 mb-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span class="font-semibold">Generating...</span>
        `;
        
        // Check if PDF already exists
        if (comparisonData.pdf_url) {
            window.open(comparisonData.pdf_url, '_blank');
            button.disabled = false;
            button.innerHTML = originalHTML;
            return;
        }
        
        // Request PDF generation
        const response = await fetch(`/api/v1/comparisons/${comparisonId}/pdf`, {
            method: 'GET'
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate PDF');
        }
        
        const result = await response.json();
        
        if (result.pdf_url) {
            // Update local data
            comparisonData.pdf_url = result.pdf_url;
            
            // Open PDF in new tab
            window.open(result.pdf_url, '_blank');
        } else {
            throw new Error('PDF URL not received');
        }
        
    } catch (error) {
        console.error('PDF download error:', error);
        alert('Failed to download PDF. Please try again.');
    } finally {
        button.disabled = false;
        button.innerHTML = originalHTML;
    }
}

// Load comparison on page load
loadComparison();
</script>
{% endblock %}
