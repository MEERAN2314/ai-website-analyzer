{% extends "base.html" %}

{% block title %}Analysis Results - AI Website Analyzer{% endblock %}

{% block head %}
<!-- Marked.js for Markdown rendering -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
/* Spinner animation */
.spinner {
    border: 4px solid #f3f4f6;
    border-top: 4px solid #2563EB;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Dark mode overrides for results page */
.dark .bg-gray-50 {
    background-color: #0f172a !important;
}

.dark .bg-white {
    background-color: #1e293b !important;
}

.dark .bg-gradient-to-br.from-blue-50 {
    background: linear-gradient(to bottom right, #1e3a8a, #312e81) !important;
}

.dark .bg-gradient-to-br.from-primary {
    background: linear-gradient(to bottom right, #1e3a8a, #312e81) !important;
}

.dark .border-blue-100 {
    border-color: rgba(59, 130, 246, 0.3) !important;
}

.dark .text-gray-900 {
    color: #f1f5f9 !important;
}

.dark .text-gray-700 {
    color: #cbd5e1 !important;
}

.dark .text-gray-600 {
    color: #94a3b8 !important;
}

.dark .text-gray-500 {
    color: #64748b !important;
}

.dark .border-gray-200 {
    border-color: rgba(255, 255, 255, 0.1) !important;
}

.dark .shadow-md {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
}

.dark .shadow-lg {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3) !important;
}

.dark input {
    background-color: #0f172a !important;
    color: #f1f5f9 !important;
    border-color: rgba(255, 255, 255, 0.2) !important;
}

.dark input::placeholder {
    color: #64748b !important;
}

.dark .bg-blue-100 {
    background-color: rgba(59, 130, 246, 0.2) !important;
}

.dark .bg-green-100 {
    background-color: rgba(16, 185, 129, 0.2) !important;
}

.dark .bg-yellow-100 {
    background-color: rgba(245, 158, 11, 0.2) !important;
}

.dark .bg-purple-100 {
    background-color: rgba(168, 85, 247, 0.2) !important;
}

.dark .bg-orange-50 {
    background-color: rgba(249, 115, 22, 0.1) !important;
}

.dark .bg-green-50 {
    background-color: rgba(16, 185, 129, 0.1) !important;
}

.dark .border-red-200 {
    border-color: rgba(239, 68, 68, 0.3) !important;
}

.dark .bg-red-50 {
    background-color: rgba(239, 68, 68, 0.1) !important;
}

.dark .text-red-800 {
    color: #fca5a5 !important;
}

.dark .bg-green-50 {
    background-color: rgba(16, 185, 129, 0.1) !important;
}

.dark .border-green-200 {
    border-color: rgba(16, 185, 129, 0.3) !important;
}

.dark .text-green-800 {
    color: #86efac !important;
}

/* Prose styles for markdown content */
.prose {
    color: #374151;
    max-width: 65ch;
}
.prose p {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    line-height: 1.75;
}
.prose h1, .prose h2, .prose h3, .prose h4 {
    color: #111827;
    font-weight: 700;
    margin-top: 1.5em;
    margin-bottom: 0.75em;
}
.prose h1 { font-size: 1.875rem; }
.prose h2 { font-size: 1.5rem; }
.prose h3 { font-size: 1.25rem; }
.prose h4 { font-size: 1.125rem; }
.prose strong {
    color: #111827;
    font-weight: 600;
}
.prose ul, .prose ol {
    margin-top: 1.25em;
    margin-bottom: 1.25em;
    padding-left: 1.625em;
}
.prose li {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
}
.prose ul > li {
    padding-left: 0.375em;
}
.prose ul > li::marker {
    color: #2563EB;
}
.prose code {
    color: #111827;
    font-weight: 600;
    font-size: 0.875em;
    background-color: #F3F4F6;
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
}
.prose blockquote {
    font-weight: 500;
    font-style: italic;
    color: #111827;
    border-left-width: 0.25rem;
    border-left-color: #E5E7EB;
    quotes: "\201C""\201D""\2018""\2019";
    margin-top: 1.6em;
    margin-bottom: 1.6em;
    padding-left: 1em;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Loading State -->
        <div id="loadingResults" class="text-center py-20">
            <div class="spinner mx-auto mb-6" style="width: 64px; height: 64px; border-width: 4px;"></div>
            <p class="text-gray-600 text-lg font-medium mb-2">Loading analysis results...</p>
            <p class="text-gray-500 text-sm">This may take a few moments</p>
        </div>
        
        <!-- Results Content -->
        <div id="resultsContent" class="hidden">
            <!-- Hero Header with Large Score -->
            <div class="bg-gradient-to-br from-primary to-secondary rounded-2xl shadow-lg p-8 mb-6 text-white">
                <div class="flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex-1 text-center md:text-left">
                        <div class="inline-block bg-white/20 backdrop-blur-md px-4 py-2 rounded-full mb-4">
                            <span class="text-sm font-semibold">âœ“ Analysis Complete</span>
                        </div>
                        <h1 class="text-3xl md:text-4xl font-bold mb-2" id="websiteUrl"></h1>
                        <p class="text-white/90 flex items-center justify-center md:justify-start">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <span id="completedDate"></span>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <div class="relative">
                            <div class="w-36 h-36 rounded-full bg-white/20 backdrop-blur-md flex flex-col items-center justify-center border-4 border-white/30">
                                <div class="text-5xl font-bold" id="overallScore"></div>
                                <p class="text-sm font-medium mt-1">Overall Score</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons Grid -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <!-- Competitor Analysis Button (NEW) -->
                <button
                    id="compareBtn"
                    class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-6 rounded-xl hover:from-orange-600 hover:to-red-700 transition transform hover:scale-105 shadow-md flex flex-col items-center space-y-2"
                >
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    <span class="font-semibold text-center">Compare</span>
                    <span class="text-xs opacity-90">vs Competitors</span>
                </button>
                
                <!-- Action Plan Button -->
                <button
                    id="actionPlanBtn"
                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-6 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition transform hover:scale-105 shadow-md flex flex-col items-center space-y-2"
                >
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="font-semibold text-center">Action Plan</span>
                    <span class="text-xs opacity-90">30/60/90 Days</span>
                </button>
                
                <!-- Download PDF Button -->
                <button
                    id="downloadPdfBtn"
                    class="bg-red-600 text-white p-6 rounded-xl hover:bg-red-700 transition transform hover:scale-105 shadow-md flex flex-col items-center space-y-2"
                >
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="font-semibold text-center">PDF Report</span>
                    <span class="text-xs opacity-90">Download</span>
                </button>
                
                <!-- Export Button -->
                <div class="relative">
                    <button
                        id="exportBtn"
                        class="w-full bg-gray-700 text-white p-6 rounded-xl hover:bg-gray-800 transition transform hover:scale-105 shadow-md flex flex-col items-center space-y-2"
                    >
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                        </svg>
                        <span class="font-semibold text-center">Export Data</span>
                        <span class="text-xs opacity-90">JSON/CSV</span>
                    </button>
                    <div id="exportMenu" class="hidden absolute left-0 mt-2 w-full bg-white rounded-lg shadow-lg py-2 z-10">
                        <a href="#" id="exportJson" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition">
                            <span class="flex items-center space-x-2">
                                <span>ðŸ“„</span>
                                <span>Export as JSON</span>
                            </span>
                        </a>
                        <a href="#" id="exportCsv" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 transition">
                            <span class="flex items-center space-x-2">
                                <span>ðŸ“Š</span>
                                <span>Export as CSV</span>
                            </span>
                        </a>
                    </div>
                </div>
                
                <!-- Share Button -->
                <button
                    id="shareBtn"
                    class="bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition transform hover:scale-105 shadow-md flex flex-col items-center space-y-2"
                >
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path>
                    </svg>
                    <span class="font-semibold text-center">Share</span>
                    <span class="text-xs opacity-90">Create Link</span>
                </button>
            </div>
            
            <!-- Score Cards with Icons and Colors -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-blue-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">UX Score</h3>
                    <div class="text-3xl font-bold text-blue-600" id="uxScore">-</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-green-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">SEO Score</h3>
                    <div class="text-3xl font-bold text-green-600" id="seoScore">-</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-yellow-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">Performance</h3>
                    <div class="text-3xl font-bold text-yellow-600" id="perfScore">-</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-purple-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">Content</h3>
                    <div class="text-3xl font-bold text-purple-600" id="contentScore">-</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-red-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">Security</h3>
                    <div class="text-3xl font-bold text-red-600" id="securityScore">-</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border-l-4 border-indigo-500 transform hover:scale-105 transition">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center mr-3">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                    </div>
                    <h3 class="text-sm text-gray-600 mb-2 font-medium">Images</h3>
                    <div class="text-3xl font-bold text-indigo-600" id="imageScore">-</div>
                </div>
            </div>
            
            <!-- AI Summary with Enhanced Design -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-md p-8 mb-6 border border-blue-100">
                <div class="flex items-start mb-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 shadow-md">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-1">AI-Powered Insights</h2>
                        <p class="text-sm text-gray-600">Comprehensive analysis powered by Google Gemini</p>
                    </div>
                </div>
                <div id="aiSummary" class="prose prose-lg max-w-none text-gray-700 leading-relaxed"></div>
            </div>
            
            <!-- Priority Recommendations with Enhanced Design -->
            <div class="bg-white rounded-2xl shadow-md p-8 mb-6">
                <div class="flex items-start mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 shadow-md">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-1">Priority Recommendations</h2>
                        <p class="text-sm text-gray-600">Key actions to improve your website</p>
                    </div>
                </div>
                <div id="recommendations" class="space-y-4"></div>
            </div>
            
            <!-- Detailed Analysis Tabs with Icons -->
            <div class="bg-white rounded-2xl shadow-md p-8 mb-6">
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex flex-wrap space-x-4 md:space-x-8">
                        <button class="tab-btn active" data-tab="ux">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"></path>
                            </svg>
                            UX
                        </button>
                        <button class="tab-btn" data-tab="seo">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            SEO
                        </button>
                        <button class="tab-btn" data-tab="performance">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Performance
                        </button>
                        <button class="tab-btn" data-tab="content">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Content
                        </button>
                        <button class="tab-btn" data-tab="security">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                            </svg>
                            Security
                        </button>
                        <button class="tab-btn" data-tab="images">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Images
                        </button>
                    </nav>
                </div>
                
                <div id="tabContent"></div>
            </div>
            
            <!-- AI Chat with Enhanced Design -->
            <div class="bg-white rounded-2xl shadow-md p-8">
                <div class="flex items-start mb-6">
                    <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-teal-600 rounded-xl flex items-center justify-center mr-4 flex-shrink-0 shadow-md">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-1">Ask AI About Your Analysis</h2>
                        <p class="text-sm text-gray-600">Get personalized answers and recommendations</p>
                    </div>
                </div>
                
                <div id="chatMessages" class="space-y-4 mb-6 max-h-96 overflow-y-auto"></div>
                
                <form id="chatForm" class="flex space-x-4">
                    <input
                        type="text"
                        id="chatInput"
                        placeholder="Ask anything about your website analysis..."
                        class="flex-1 px-6 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                    >
                    <button
                        type="submit"
                        class="bg-primary text-white px-8 py-4 rounded-xl hover:bg-secondary transition transform hover:scale-105 flex items-center space-x-2"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                        </svg>
                        <span>Send</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.tab-btn {
    padding: 1rem 0;
    border-bottom: 3px solid transparent;
    font-weight: 500;
    color: #6b7280;
    transition: all 0.3s;
    display: flex;
    align-items: center;
}

.tab-btn.active {
    color: #2563EB;
    border-bottom-color: #2563EB;
}

.tab-btn:hover {
    color: #2563EB;
}

.tab-btn svg {
    transition: transform 0.3s;
}

.tab-btn:hover svg {
    transform: scale(1.1);
}
</style>

<script>
const analysisId = '{{ analysis_id }}';
let currentAnalysis = null;

// Helper functions
function getToken() {
    return localStorage.getItem('access_token');
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function getScoreColor(score) {
    if (score >= 80) return 'text-green-600';
    if (score >= 60) return 'text-yellow-600';
    if (score >= 40) return 'text-orange-600';
    return 'text-red-600';
}

function showNotification(message, type = 'info') {
    const colors = {
        'info': 'bg-blue-500',
        'success': 'bg-green-500',
        'error': 'bg-red-500',
        'warning': 'bg-yellow-500'
    };
    
    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(20px)';
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateY(0)';
    }, 10);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(20px)';
        setTimeout(() => document.body.removeChild(notification), 300);
    }, 3000);
}

async function loadResults() {
    try {
        console.log('Loading results for analysis:', analysisId);
        const response = await fetch(`/api/v1/analysis/${analysisId}`);
        const data = await response.json();
        
        console.log('Response status:', response.status);
        console.log('Response data:', data);
        
        if (!response.ok) {
            throw new Error(data.detail || 'Failed to load results');
        }
        
        currentAnalysis = data;
        
        // Check if still processing
        if (data.status === 'pending' || data.status === 'processing') {
            console.log('Analysis still processing, will retry in 3 seconds');
            setTimeout(loadResults, 3000); // Poll every 3 seconds
            return;
        }
        
        if (data.status === 'failed') {
            console.error('Analysis failed:', data.error_message);
            showNotification('Analysis failed. Please try again.', 'error');
            document.getElementById('loadingResults').innerHTML = `
                <div class="text-center py-20">
                    <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-gray-600">Analysis failed. Please try again.</p>
                    <a href="/analyze" class="mt-4 inline-block bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary transition">
                        Try Again
                    </a>
                </div>
            `;
            return;
        }
        
        // Display results
        console.log('Displaying results');
        displayResults(data);
        
    } catch (error) {
        console.error('Error loading results:', error);
        showNotification('Failed to load results: ' + error.message, 'error');
        document.getElementById('loadingResults').innerHTML = `
            <div class="text-center py-20">
                <svg class="w-16 h-16 text-red-500 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-gray-600">Error: ${error.message}</p>
                <a href="/analyze" class="mt-4 inline-block bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary transition">
                    Try Again
                </a>
            </div>
        `;
    }
}

function displayResults(data) {
    console.log('Displaying results:', data);
    
    document.getElementById('loadingResults').classList.add('hidden');
    document.getElementById('resultsContent').classList.remove('hidden');
    
    // Check if this is an old analysis without new analyzers
    const hasNewAnalyzers = data.security_analysis && data.image_analysis;
    if (!hasNewAnalyzers) {
        // Show notification banner
        const banner = document.createElement('div');
        banner.className = 'bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded-r-lg';
        banner.innerHTML = `
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="text-sm font-semibold text-blue-900 mb-1">New Analysis Features Available</h3>
                    <p class="text-sm text-blue-700">This analysis was created before Security and Image optimization features were added. Run a new analysis to see these additional insights!</p>
                </div>
            </div>
        `;
        const resultsContent = document.getElementById('resultsContent');
        resultsContent.insertBefore(banner, resultsContent.firstChild);
    }
    
    // Header
    document.getElementById('websiteUrl').textContent = data.website_url;
    document.getElementById('completedDate').textContent = formatDate(data.completed_at);
    
    // Overall score
    const overallScoreEl = document.getElementById('overallScore');
    overallScoreEl.textContent = data.overall_score.toFixed(0);
    overallScoreEl.className = `text-5xl font-bold ${getScoreColor(data.overall_score)}`;
    
    // Individual scores
    document.getElementById('uxScore').textContent = data.ux_analysis.score.toFixed(0);
    document.getElementById('seoScore').textContent = data.seo_analysis.score.toFixed(0);
    document.getElementById('perfScore').textContent = data.performance_analysis.score.toFixed(0);
    document.getElementById('contentScore').textContent = data.content_analysis.score.toFixed(0);
    
    // Handle new analyzers with visual feedback
    const securityScore = data.security_analysis && data.security_analysis.score ? data.security_analysis.score : 0;
    const imageScore = data.image_analysis && data.image_analysis.score ? data.image_analysis.score : 0;
    
    const securityScoreEl = document.getElementById('securityScore');
    const imageScoreEl = document.getElementById('imageScore');
    
    securityScoreEl.textContent = securityScore.toFixed(0);
    imageScoreEl.textContent = imageScore.toFixed(0);
    
    // Add visual indicator for missing data
    if (securityScore === 0 && !data.security_analysis) {
        securityScoreEl.parentElement.style.opacity = '0.5';
        securityScoreEl.title = 'Run a new analysis to see Security score';
    }
    if (imageScore === 0 && !data.image_analysis) {
        imageScoreEl.parentElement.style.opacity = '0.5';
        imageScoreEl.title = 'Run a new analysis to see Image optimization score';
    }
    
    // AI Summary - render as markdown
    const aiSummaryEl = document.getElementById('aiSummary');
    try {
        console.log('AI Summary:', data.ai_summary);
        // Check if marked is available
        if (typeof marked !== 'undefined' && marked.parse) {
            aiSummaryEl.innerHTML = marked.parse(data.ai_summary || 'No summary available');
        } else if (typeof marked !== 'undefined') {
            // Fallback for older marked versions
            aiSummaryEl.innerHTML = marked(data.ai_summary || 'No summary available');
        } else {
            // Fallback if marked is not loaded
            console.warn('Marked.js not loaded, using fallback');
            aiSummaryEl.innerHTML = formatTextAsHTML(data.ai_summary || 'No summary available');
        }
    } catch (error) {
        console.error('Error rendering markdown:', error);
        aiSummaryEl.innerHTML = formatTextAsHTML(data.ai_summary || 'No summary available');
    }
    
    // Recommendations
    console.log('Recommendations:', data.priority_recommendations);
    const recsDiv = document.getElementById('recommendations');
    if (data.priority_recommendations && data.priority_recommendations.length > 0) {
        recsDiv.innerHTML = data.priority_recommendations.map(rec => `
            <div class="border-l-4 ${getPriorityColor(rec.priority)} bg-gray-50 p-4">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-semibold text-lg">${rec.title}</h3>
                    <span class="px-2 py-1 text-xs font-semibold rounded ${getPriorityBadge(rec.priority)}">
                        ${rec.priority} Priority
                    </span>
                </div>
                <p class="text-gray-700 mb-2">${rec.description}</p>
                <div class="flex space-x-4 text-sm text-gray-600">
                    <span>Impact: ${rec.impact}</span>
                    <span>Effort: ${rec.effort}</span>
                    <span>Category: ${rec.category}</span>
                </div>
            </div>
        `).join('');
    } else {
        recsDiv.innerHTML = '<p class="text-gray-600">No recommendations available</p>';
    }
    
    // Setup tabs
    setupTabs(data);
}

function setupTabs(data) {
    const tabs = document.querySelectorAll('.tab-btn');
    const tabContent = document.getElementById('tabContent');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            
            const tabName = tab.dataset.tab;
            displayTabContent(tabName, data);
        });
    });
    
    // Show first tab
    displayTabContent('ux', data);
}

function displayTabContent(tab, data) {
    const tabContent = document.getElementById('tabContent');
    const analysisData = data[`${tab}_analysis`];
    
    console.log(`Displaying ${tab} tab:`, analysisData);
    console.log('Full data object:', data);
    
    if (!analysisData || !analysisData.score) {
        // Check if this is a new analyzer that might not have data yet
        if (tab === 'security' || tab === 'images') {
            tabContent.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 text-center">
                    <svg class="w-16 h-16 mx-auto mb-4 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Analysis Not Available</h3>
                    <p class="text-gray-600 mb-4">This analysis was performed before ${tab === 'security' ? 'Security' : 'Image'} analysis was added.</p>
                    <p class="text-sm text-gray-500">Please run a new analysis to see ${tab === 'security' ? 'security' : 'image optimization'} results.</p>
                </div>
            `;
        } else {
            tabContent.innerHTML = '<p class="text-gray-600">No data available for this analysis</p>';
        }
        return;
    }
    
    const issues = analysisData.issues || [];
    const recommendations = analysisData.recommendations || [];
    
    tabContent.innerHTML = `
        <div class="space-y-4">
            <div>
                <h3 class="font-semibold text-lg mb-2">Issues Found</h3>
                ${issues.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        ${issues.map(issue => `<li>${issue}</li>`).join('')}
                    </ul>
                ` : '<p class="text-gray-600">No issues found</p>'}
            </div>
            <div>
                <h3 class="font-semibold text-lg mb-2">Recommendations</h3>
                ${recommendations.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1 text-gray-700">
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                ` : '<p class="text-gray-600">No recommendations available</p>'}
            </div>
        </div>
    `;
}

function getPriorityColor(priority) {
    const colors = {
        'High': 'border-red-500',
        'Medium': 'border-yellow-500',
        'Low': 'border-green-500'
    };
    return colors[priority] || 'border-gray-500';
}

function getPriorityBadge(priority) {
    const badges = {
        'High': 'bg-red-100 text-red-800',
        'Medium': 'bg-yellow-100 text-yellow-800',
        'Low': 'bg-green-100 text-green-800'
    };
    return badges[priority] || 'bg-gray-100 text-gray-800';
}

// Chat functionality moved to setupEventListeners()

function addChatMessage(role, message) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-bubble ${role}`;
    
    // Render markdown for assistant messages
    if (role === 'assistant') {
        try {
            if (typeof marked !== 'undefined' && marked.parse) {
                messageDiv.innerHTML = marked.parse(message);
            } else if (typeof marked !== 'undefined') {
                messageDiv.innerHTML = marked(message);
            } else {
                messageDiv.innerHTML = formatTextAsHTML(message);
            }
        } catch (error) {
            console.error('Error rendering chat markdown:', error);
            messageDiv.innerHTML = formatTextAsHTML(message);
        }
    } else {
        messageDiv.textContent = message;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Helper function to format text as HTML (fallback)
function formatTextAsHTML(text) {
    if (!text) return '';
    
    // Convert markdown-style formatting to HTML
    return text
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$3</h3>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
}

// PDF Download moved to setupEventListeners()

// Load results on page load
document.addEventListener('DOMContentLoaded', () => {
    loadResults();
    
    // Setup event listeners after DOM is loaded
    setupEventListeners();
});

function setupEventListeners() {
    // Compare with Competitors Button (NEW)
    const compareBtn = document.getElementById('compareBtn');
    if (compareBtn) {
        compareBtn.addEventListener('click', () => {
            // Get current website URL from analysis data
            const websiteUrl = currentAnalysisData?.website_url || '';
            // Redirect to comparison page with pre-filled URL
            window.location.href = `/compare?url=${encodeURIComponent(websiteUrl)}`;
        });
    }
    
    // PDF Download
    const downloadPdfBtn = document.getElementById('downloadPdfBtn');
    if (downloadPdfBtn) {
        downloadPdfBtn.addEventListener('click', async () => {
            try {
                // Disable button and show loading state
                downloadPdfBtn.disabled = true;
                downloadPdfBtn.innerHTML = `
                    <div class="spinner mx-auto mb-2" style="width: 24px; height: 24px; border-width: 2px;"></div>
                    <span class="font-semibold text-center">Generating...</span>
                    <span class="text-xs opacity-90">Please wait</span>
                `;
                
                showNotification('Generating PDF report...', 'info');
                
                const response = await fetch(`/api/v1/analysis/${analysisId}/pdf`);
                const data = await response.json();
                
                if (response.ok && data.pdf_url) {
                    // Open PDF in new tab
                    const pdfWindow = window.open(data.pdf_url, '_blank');
                    
                    if (pdfWindow) {
                        showNotification('PDF report opened in new tab', 'success');
                    } else {
                        // If popup blocked, provide download link
                        showNotification('Please allow popups or click here to download', 'warning');
                        setTimeout(() => {
                            window.location.href = data.pdf_url;
                        }, 1000);
                    }
                } else if (response.status === 400) {
                    showNotification(data.detail || 'Analysis not complete yet. Please wait.', 'warning');
                } else if (response.status === 404) {
                    showNotification(data.detail || 'PDF not found. Generating now...', 'warning');
                    // Retry after a short delay
                    setTimeout(() => {
                        downloadPdfBtn.click();
                    }, 2000);
                } else {
                    showNotification(data.detail || 'Failed to generate PDF report', 'error');
                }
            } catch (error) {
                console.error('Error downloading PDF:', error);
                showNotification('Failed to download PDF: ' + error.message, 'error');
            } finally {
                // Restore button state
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.innerHTML = `
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span class="font-semibold text-center">PDF Report</span>
                    <span class="text-xs opacity-90">Download</span>
                `;
            }
        });
    }
    
    // Export dropdown toggle
    const exportBtn = document.getElementById('exportBtn');
    const exportMenu = document.getElementById('exportMenu');
    if (exportBtn && exportMenu) {
        exportBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            exportMenu.classList.toggle('hidden');
        });
        
        // Close export menu when clicking outside
        document.addEventListener('click', () => {
            exportMenu.classList.add('hidden');
        });
    }
    
    // Export JSON
    const exportJson = document.getElementById('exportJson');
    if (exportJson) {
        exportJson.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch(`/api/v1/export/${analysisId}/json`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis-${analysisId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showNotification('Analysis exported as JSON', 'success');
            } catch (error) {
                showNotification('Failed to export JSON', 'error');
            }
        });
    }
    
    // Export CSV
    const exportCsv = document.getElementById('exportCsv');
    if (exportCsv) {
        exportCsv.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const response = await fetch(`/api/v1/export/${analysisId}/csv`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis-${analysisId}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                showNotification('Analysis exported as CSV', 'success');
            } catch (error) {
                showNotification('Failed to export CSV', 'error');
            }
        });
    }
    
    // Action Plan Modal
    const actionPlanBtn = document.getElementById('actionPlanBtn');
    if (actionPlanBtn) {
        actionPlanBtn.addEventListener('click', async () => {
            try {
                const response = await fetch(`/api/v1/export/${analysisId}/action-plan`);
                const data = await response.json();
                
                if (response.ok) {
                    showActionPlanModal(data);
                } else {
                    showNotification('Action plan not available yet', 'warning');
                }
            } catch (error) {
                showNotification('Failed to load action plan', 'error');
            }
        });
    }
    
    // Share Button
    const shareBtn = document.getElementById('shareBtn');
    if (shareBtn) {
        shareBtn.addEventListener('click', async () => {
            showShareModal();
        });
    }
    
    // Chat Form
    const chatForm = document.getElementById('chatForm');
    if (chatForm) {
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/v1/analysis/${analysisId}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addChatMessage('assistant', data.message);
                } else {
                    showNotification('Failed to send message', 'error');
                }
            } catch (error) {
                showNotification('An error occurred', 'error');
            }
        });
    }
}

// Old duplicate event listeners removed - now handled in setupEventListeners()

function showActionPlanModal(actionPlan) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-900">ðŸ“‹ 30/60/90 Day Action Plan</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="prose max-w-none" id="actionPlanContent"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Render markdown
    const content = document.getElementById('actionPlanContent');
    if (typeof marked !== 'undefined' && marked.parse) {
        content.innerHTML = marked.parse(actionPlan.roadmap || 'No action plan available');
    } else {
        content.innerHTML = formatTextAsHTML(actionPlan.roadmap || 'No action plan available');
    }
}

// Share Button moved to setupEventListeners()

function showShareModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="bg-white rounded-lg max-w-md w-full">
            <div class="border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">ðŸ”— Share Analysis</h2>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Link expires in (days):
                    </label>
                    <input 
                        type="number" 
                        id="expiryDays" 
                        value="7" 
                        min="1" 
                        max="30"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"
                    >
                </div>
                <button 
                    onclick="generateShareLink()" 
                    class="w-full bg-primary text-white px-6 py-3 rounded-lg hover:bg-secondary transition font-semibold"
                >
                    Generate Share Link
                </button>
                <div id="shareLinkResult" class="mt-4"></div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

async function generateShareLink() {
    const expiryDays = document.getElementById('expiryDays').value;
    const resultDiv = document.getElementById('shareLinkResult');
    
    try {
        const token = getToken();
        const response = await fetch(`/api/v1/share/${analysisId}/share`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify({ expires_in_days: parseInt(expiryDays) })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            const shareUrl = `${window.location.origin}/share/${data.share_token}`;
            resultDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <p class="text-sm font-medium text-green-800 mb-2">âœ… Share link created!</p>
                    <div class="flex items-center space-x-2">
                        <input 
                            type="text" 
                            value="${shareUrl}" 
                            readonly 
                            class="flex-1 px-3 py-2 bg-white border border-gray-300 rounded text-sm"
                            id="shareUrlInput"
                        >
                        <button 
                            onclick="copyShareLink()" 
                            class="bg-primary text-white px-4 py-2 rounded hover:bg-secondary transition text-sm"
                        >
                            Copy
                        </button>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">
                        Expires: ${new Date(data.expires_at).toLocaleDateString()}
                    </p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-sm text-red-800">âŒ ${data.detail || 'Failed to create share link'}</p>
                </div>
            `;
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-sm text-red-800">âŒ Error creating share link</p>
            </div>
        `;
    }
}

function copyShareLink() {
    const input = document.getElementById('shareUrlInput');
    input.select();
    document.execCommand('copy');
    showNotification('Link copied to clipboard!', 'success');
}
</script>
{% endblock %}
